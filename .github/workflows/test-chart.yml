name: Test Helm Chart

on:
  push:
    branches:
      - main
  pull_request:

env:
  TEST_IMAGE_TAG: v0.1.0-test

jobs:
  test-helm-chart:
    name: Test Helm Chart Installation
    runs-on: ubuntu-latest
    steps:
      - name: Clone the code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Install the latest version of kind
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/latest/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind

      - name: Verify kind installation
        run: kind version

      - name: Create kind cluster
        run: kind create cluster

      - name: Prepare mcp-operator
        run: |
          go mod tidy
          make docker-build IMG=mcp-operator:${{ env.TEST_IMAGE_TAG }}
          kind load docker-image mcp-operator:${{ env.TEST_IMAGE_TAG }}

      - name: Verify image loaded in Kind
        run: |
          echo "Images available in Kind cluster:"
          docker exec kind-control-plane crictl images | grep mcp-operator || echo "Warning: mcp-operator image not found!"

      - name: Install Helm
        run: |
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

      - name: Verify Helm installation
        run: helm version

      - name: Lint Helm Chart
        run: |
          helm lint ./dist/chart

      - name: Install Prometheus Operator CRDs
        run: |
          helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
          helm repo update
          helm install prometheus-crds prometheus-community/prometheus-operator-crds

      - name: Install Helm chart for project
        run: |
          helm install my-release ./dist/chart \
            --create-namespace \
            --namespace mcp-operator-system \
            --set controllerManager.container.image.repository=mcp-operator \
            --set controllerManager.container.image.tag=${{ env.TEST_IMAGE_TAG }} \
            --set prometheus.enable=true \
            --set grafana.enabled=true

      - name: Check Helm release status
        run: |
          helm status my-release --namespace mcp-operator-system

      - name: Wait for operator deployment
        id: wait-deployment
        run: |
          kubectl wait --for=condition=available --timeout=120s \
            deployment/mcp-operator-controller-manager \
            -n mcp-operator-system

      - name: Debug - Get pod status (on failure)
        if: failure() && steps.wait-deployment.conclusion == 'failure'
        run: |
          echo "=== Pods in mcp-operator-system ==="
          kubectl get pods -n mcp-operator-system

          echo -e "\n=== Deployment description ==="
          kubectl describe deployment mcp-operator-controller-manager -n mcp-operator-system

          echo -e "\n=== Pod descriptions ==="
          kubectl describe pods -n mcp-operator-system

          echo -e "\n=== Pod logs ==="
          kubectl logs -n mcp-operator-system -l control-plane=controller-manager --all-containers --tail=100 || true

          echo -e "\n=== Recent events ==="
          kubectl get events -n mcp-operator-system --sort-by='.lastTimestamp'

      - name: Check ServiceMonitor creation
        run: |
          kubectl get servicemonitor -n mcp-operator-system
          kubectl wait --namespace mcp-operator-system \
            --for=jsonpath='{.kind}'=ServiceMonitor \
            --timeout=30s \
            servicemonitor/mcp-operator-controller-manager-metrics-monitor

      - name: Verify ServiceMonitor labels
        run: |
          # Check that ServiceMonitor has the release label
          RELEASE_LABEL=$(kubectl get servicemonitor mcp-operator-controller-manager-metrics-monitor \
            -n mcp-operator-system \
            -o jsonpath='{.metadata.labels.release}')

          if [ "$RELEASE_LABEL" != "monitoring" ]; then
            echo "ERROR: ServiceMonitor missing 'release: monitoring' label"
            echo "Found label value: $RELEASE_LABEL"
            exit 1
          fi

          echo "âœ… ServiceMonitor has correct 'release: monitoring' label"
